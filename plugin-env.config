# plugin-env.config
# =============================================================================
# Plugin Environment Configuration (Auto-Sourced)
# =============================================================================
# This file is automatically sourced by mars-env.config when the plugin is
# registered and enabled. Use it to define plugin-specific environment
# variables that should be available in the shell environment.
#
# This file is sourced AFTER:
#   - MARS_REPO_ROOT is set
#   - MARS_MODE is determined
#   - MARS_USER_PLUGIN_HOST_PATH is set
#
# Example exports:
#   export MY_PLUGIN_VAR="value"
#   export MY_API_KEY="${MY_API_KEY:-default-key}"
#
# Note: For secrets, prefer the credential scripts pattern (hooks/.credential-scripts)
#       which supports loading from script outputs, not just static values.
# =============================================================================

# Source the plugin's config.sh to get MARS_USER_CREDENTIALS_* variables
# This makes the plugin's configuration available in the environment
_PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd -P)"
if [ -f "${_PLUGIN_DIR}/config.sh" ]; then
    # shellcheck disable=SC1091
    source "${_PLUGIN_DIR}/config.sh"
fi
unset _PLUGIN_DIR

# =============================================================================
# Add your plugin-specific environment variables below
# =============================================================================

# =============================================================================
# Credential Script Directory (ADR-0044) - Mode-Aware Configuration
# =============================================================================
# MARS supports two deployment modes for services like GitLab and Ollama:
#   - "swarm" mode: Services run INSIDE E30 super-container (Docker-in-Docker)
#   - "sibling" mode: Services run ALONGSIDE E30 on host Docker
#
# Credential paths differ based on where the code is running:
#   - On HOST: Credentials are at actual host path (MARS_CREDENTIALS_HOST_PATH)
#   - In E30: Credentials are at mount target (MARS_CREDENTIALS_CONTAINER_PATH)
#
# The external-mounts.yml mounts:
#   ${MARS_CREDENTIALS_HOST_PATH} --> ${MARS_CREDENTIALS_CONTAINER_PATH}
#
# =============================================================================

# Host-relative path: Where credential files actually live on the host filesystem
# This is the SOURCE of the bind mount
export MARS_CREDENTIALS_HOST_PATH="${MARS_CREDENTIALS_HOST_PATH:-${HOME}/dev/joe-docs/dev-ops/mars}"

# Container-relative path: Where credentials are mounted INSIDE E30/E6 containers
# This is the TARGET of the bind mount (defined in external-mounts.yml)
export MARS_CREDENTIALS_CONTAINER_PATH="${MARS_CREDENTIALS_CONTAINER_PATH:-/root/.mars/credentials}"

# =============================================================================
# Auto-detect execution context and set CREDENTIAL_SCRIPT_DIR accordingly
# =============================================================================
# Detection methods (in order of reliability):
#   1. /.dockerenv file exists (Docker container)
#   2. /run/.containerenv exists (Podman/OCI container)
#   3. Checking cgroup for docker/lxc/containerd
#
# If already set explicitly, respect user's choice.
# =============================================================================

if [ -z "${CREDENTIAL_SCRIPT_DIR}" ]; then
    if [ -f "/.dockerenv" ] || [ -f "/run/.containerenv" ] || grep -qE "(docker|lxc|containerd)" /proc/1/cgroup 2>/dev/null; then
        # Running INSIDE a container (E6 or E30)
        # Use the container-relative path (mount target)
        export CREDENTIAL_SCRIPT_DIR="${MARS_CREDENTIALS_CONTAINER_PATH}"
    else
        # Running on HOST (for sibling mode services or CLI usage)
        # Use the host-relative path (actual file location)
        export CREDENTIAL_SCRIPT_DIR="${MARS_CREDENTIALS_HOST_PATH}"
    fi
else
    # Already set - respect explicit configuration
    export CREDENTIAL_SCRIPT_DIR="${CREDENTIAL_SCRIPT_DIR}"
fi

# =============================================================================
# Load GitLab Admin Credentials (Multi-Value, must be sourced not executed)
# =============================================================================
# These are used for GitLab web UI admin access.
# Different from GITLAB_PERSONAL_ACCESS_TOKEN which is for API access.
# See: modules/services/gitlab-ce/docs/CREDENTIALS.md
# =============================================================================

_gitlab_admin_script="${CREDENTIAL_SCRIPT_DIR}/gitlab-admin.sh"
if [ -f "$_gitlab_admin_script" ]; then
    # shellcheck disable=SC1090
    source "$_gitlab_admin_script"
fi
unset _gitlab_admin_script

# Set defaults for GitLab admin if not configured
export GITLAB_ADMIN_USER="${GITLAB_ADMIN_USER:-root}"
export GITLAB_ADMIN_PASS="${GITLAB_ADMIN_PASS:-changeme}"
